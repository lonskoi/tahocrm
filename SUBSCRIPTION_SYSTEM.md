# Система подписок и управления мастерскими

## Обзор

Полноценная SaaS-платформа с системой подписок, контроля оплаты и управления доступом мастерских.

## Возможности

### Для владельца платформы (SUPER_ADMIN)

1. **Управление мастерскими**
   - Просмотр всех мастерских
   - Создание новых мастерских
   - Блокировка/разблокировка мастерских
   - Просмотр статистики по каждой мастерской

2. **Контроль подписок**
   - Просмотр статусов подписок
   - Управление планами (BASIC, PROFESSIONAL, ENTERPRISE)
   - Контроль сроков подписок
   - Управление пробными периодами

3. **Контроль оплаты**
   - Просмотр платежей
   - Отслеживание неоплаченных подписок
   - Автоматическая блокировка при неоплате

4. **Мониторинг использования**
   - Количество пользователей
   - Количество транспортных средств
   - Количество заказов в месяц
   - Контроль лимитов

### Для мастерских

1. **Изоляция данных**
   - Каждая мастерская видит только свои данные
   - Строгое разделение по tenantId

2. **Лимиты использования**
   - Ограничение количества пользователей
   - Ограничение количества ТС
   - Ограничение заказов в месяц

3. **Уведомления**
   - О приближении окончания подписки
   - О превышении лимитов
   - О необходимости оплаты

## Планы подписки

### BASIC

- До 5 пользователей
- До 50 транспортных средств
- До 100 заказов в месяц
- Базовая поддержка

### PROFESSIONAL

- До 20 пользователей
- До 200 транспортных средств
- До 500 заказов в месяц
- Приоритетная поддержка
- Расширенная аналитика

### ENTERPRISE

- Неограниченно пользователей
- Неограниченно транспортных средств
- Неограниченно заказов
- Персональный менеджер
- Кастомные интеграции

## Статусы подписки

- **TRIAL** - Пробный период (14-30 дней)
- **ACTIVE** - Активная подписка
- **SUSPENDED** - Приостановлена (не оплачено)
- **CANCELLED** - Отменена пользователем
- **EXPIRED** - Истекла
- **BLOCKED** - Заблокирована администратором

## Блокировка мастерских

### Автоматическая блокировка

- При неоплате подписки (статус SUSPENDED)
- При истечении срока подписки (статус EXPIRED)
- При превышении лимитов (временно)

### Ручная блокировка

- Через админ-панель супер-админа
- С указанием причины
- С возможностью разблокировки

### Последствия блокировки

- Все пользователи мастерской теряют доступ
- API возвращает ошибку 403
- Данные сохраняются, но недоступны

## API для управления

### Получить список мастерских

```
GET /api/admin/tenants
```

### Заблокировать мастерскую

```
POST /api/admin/tenants/{id}/block
Body: { "reason": "Неоплата подписки" }
```

### Разблокировать мастерскую

```
POST /api/admin/tenants/{id}/unblock
```

### Создать мастерскую

```
POST /api/admin/tenants
Body: {
  "name": "Название",
  "inn": "1234567890",
  "email": "email@example.com",
  "subscriptionPlan": "BASIC"
}
```

## Проверка доступа

Система автоматически проверяет доступ при каждом запросе:

```typescript
import { checkTenantAccess } from '@/lib/tenant-check'

const { allowed, reason } = await checkTenantAccess(tenantId)
if (!allowed) {
  // Блокировать доступ
}
```

## Лимиты

Проверка лимитов перед созданием ресурсов:

```typescript
import { checkTenantLimits } from '@/lib/tenant-check'

const { allowed, current, max } = await checkTenantLimits(tenantId, 'users')
if (!allowed) {
  // Показать ошибку о превышении лимита
}
```

## Мониторинг

### Ежедневные задачи

- Проверка истекших подписок
- Автоматическая блокировка неоплаченных
- Сброс счетчиков заказов (начало месяца)
- Отправка уведомлений

### Метрики

- Количество активных мастерских
- Количество заблокированных
- Средний доход на мастерскую
- Конверсия из TRIAL в ACTIVE

## Безопасность

1. **Изоляция данных**
   - Все запросы фильтруются по tenantId
   - Невозможно получить данные другой мастерской

2. **Проверка прав**
   - Только SUPER_ADMIN может управлять мастерскими
   - Проверка на каждом API запросе

3. **Аудит**
   - Все действия логируются
   - История блокировок/разблокировок
   - Отслеживание изменений подписок

## Интеграция с платежными системами

В будущем можно интегрировать:

- ЮKassa
- Stripe
- PayPal
- Банковские переводы

Платежи сохраняются в таблице `Payment` с привязкой к подписке.
